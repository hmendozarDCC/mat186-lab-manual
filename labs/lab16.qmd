# Lab 16: Analysis of Variance (ANOVA)

## Learning Objectives
* Understand when to use **ANOVA** instead of multiple t-tests.
* State the Null ($H_0$) and Alternative ($H_a$) hypotheses for multiple groups.
* Conduct a **One-Way ANOVA** in R.
* Perform **Post-hoc testing** (Tukeyâ€™s HSD) to find exactly where differences lie.

---

## Part 1: Why ANOVA?
If you have three groups (e.g., Freshman, Sophomores, Juniors) and you want to compare their average GPA, you *could* run three separate t-tests. However, every time you run a test, there is a 5% chance of being wrong. By the third test, your error rate has ballooned! 

**ANOVA** tests all groups at once, keeping our error rate at 5%.

* **Null Hypothesis ($H_0$):** All group means are equal ($\mu_1 = \mu_2 = \mu_3$).
* **Alternative Hypothesis ($H_a$):** At least one group mean is different.



---

## Part 2: Visualizing Multiple Groups
With ANOVA, side-by-side boxplots are essential. They allow us to see if the "spread" within groups is smaller than the "distance" between groups.

```{r}
#| label: fig-height-eye-color
#| fig-cap: "Distribution of heights across characters with blue, brown, yellow, and orange eyes."
#| fig-alt: "A side-by-side boxplot comparing height across four eye color categories. The 'yellow' eye color group shows the highest median height and the most spread, while 'blue' and 'brown' are more compact and similar in height. A few low outliers are visible in the 'brown' and 'blue' categories. The y-axis represents height in centimeters."
#| warning: false
#| message: false

library(tidyverse)

# Filter for the most common eye colors to avoid a cluttered plot
eye_data <- starwars |> 
  filter(eye_color %in% c("blue", "brown", "yellow", "orange")) |>
  drop_na(height)

ggplot(eye_data, aes(x = eye_color, y = height, fill = eye_color)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_viridis_d() + # High contrast, color-blind safe palette
  theme_minimal() +
  labs(title = "Height Distribution by Eye Color",
       x = "Eye Color",
       y = "Height (cm)",
       fill = "Eye Color")
```

---

## Part 3: Running the ANOVA in R
We use the `aov()` function. Like the t-test, we use the formula `numeric_variable ~ categorical_variable`.

```{r}
#| label: tbl-anova-eye-color
#| tbl-cap: "One-way ANOVA results comparing mean heights across eye color groups."

library(broom)

# 1. Fit the ANOVA model
model <- aov(height ~ eye_color, data = eye_data)

# 2. Tidy the results into an accessible table
tidy_anova <- tidy(model)

# 3. Create a clean table with descriptive headers
knitr::kable(
  tidy_anova,
  col.names = c("Term", "Degrees of Freedom", "Sum of Squares", "Mean Square", "F-statistic", "p-value"),
  digits = 3
)
```

### How to read the ANOVA Table:

* **Df:** Degrees of freedom.
* **F value:** The ratio of variance *between* groups to variance *within* groups. A large F-value usually leads to a small p-value.
* **Pr(>F):** This is your **p-value**. If it is < 0.05, we reject the Null.



---

## Part 4: Post-hoc Testing (Tukey's HSD)
If your ANOVA p-value is significant, you know *someone* is different, but you don't know who. We use **Tukeyâ€™s Honest Significant Difference** to compare every possible pair.

```{r}
#| label: tbl-tukey-posthoc
#| tbl-cap: "Tukey HSD Post-Hoc comparisons for height across eye color groups."

library(broom)

# 1. Run Tukey's HSD
tukey_results <- TukeyHSD(model)

# 2. Tidy the results into a clean table
# TukeyHSD returns a list, so we tidy the 'eye_color' element
tidy_tukey <- tidy(tukey_results)

# 3. Create the accessible table
knitr::kable(
  tidy_tukey[, c("contrast", "estimate", "conf.low", "conf.high", "adj.p.value")],
  col.names = c("Comparison", "Difference in Means", "Lower 95% CI", "Upper 95% CI", "Adjusted p-value"),
  digits = 3
)
```
---

<div class="dcc-important">
**Lab Task 16:**

1. Identify a categorical variable in your data with **3 or more groups** (e.g., County, Year, or Category).
2. Create a **Boxplot** comparing a numeric variable across these groups.
3. Run the `aov()` function and look at the `summary()`.
4. **Conclusion:** * If p > 0.05: State that there is no significant difference between any groups.
   * If p < 0.05: Run `TukeyHSD()` and identify which specific pairs are actually different.
</div>

---

## Pro-Tip: The "Equal Variance" Assumption
ANOVA assumes that the "spread" (variance) is roughly the same for all groups. If one boxplot is massive and another is tiny, the math might be unreliable. In those cases, we go back to the **Non-parametric** methods from Lab 15!

---

::: {.callout-tip}
### Done with the Lab?
If you have finished all the tasks above, you can verify your work against the official solutions.

<center>
<a href="../solutions.html" class="btn btn-outline-success" role="button">ðŸ”“ Access Lab Solutions</a>
</center>
:::

